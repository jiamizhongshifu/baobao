# 宝宝故事应用项目规则

本文档汇总了宝宝故事应用项目的所有设计和开发规则，作为团队成员的参考指南。详细规则请参阅各规则配置文件。

## 设计语言规范

宝宝故事应用采用了iOS风格的设计语言，专为儿童和家长设计，确保界面友好、易用且吸引人。

### 核心设计原则

1. **以儿童为中心**：所有设计决策应优先考虑儿童用户体验
2. **简单易懂**：界面简洁明了，减少认知负担
3. **视觉吸引**：使用明亮、友好的色彩系统
4. **一致性**：保持整个应用的视觉和交互一致性
5. **可访问性**：设计应兼顾各类用户的需求

### 设计系统组成

- **颜色系统**：主色调（蓝色系）、中性色、语义色和背景色
- **排版**：iOS系统字体，明确的字体大小和权重层级
- **间距**：一致的间距系统，确保界面节奏感
- **圆角**：统一的圆角半径规范，增强友好感
- **阴影**：轻微的阴影效果，增强深度感
- **动画**：流畅的过渡动画，增强交互体验

### 组件库规范

- **按钮**：主按钮、次级按钮、图标按钮等
- **卡片**：故事卡片、信息卡片等
- **输入控件**：表单输入、选择器等
- **列表**：故事列表、设置列表等
- **反馈组件**：加载状态、错误状态、空状态等

详见 [design_system.json](rules/design_system.json)

## 代码规范

项目采用严格的代码规范，确保代码质量、可维护性和性能。

### Swift代码规范

- **架构模式**：MVVM + Coordinator
- **命名约定**：类使用PascalCase，变量/方法使用camelCase
- **代码组织**：使用MARK分隔代码段，按功能组织代码
- **内存管理**：避免循环引用，使用weak/unowned引用
- **错误处理**：定义明确的错误类型，使用throws传递错误
- **并发处理**：使用Swift并发系统（async/await）
- **依赖注入**：使用属性注入或构造函数注入
- **文档注释**：使用三斜线注释（///）标记公开API

### WebView开发规范

- **JavaScript桥接**：安全的消息传递机制
- **性能监控**：监控资源加载、内存使用和页面性能
- **错误处理**：捕获并处理所有JavaScript错误
- **进程管理**：优雅处理WebView进程终止
- **本地文件访问**：正确配置文件访问权限
- **安全措施**：验证所有从JavaScript接收的数据

### HTML和CSS规范

- **语义化HTML**：使用正确的语义标签
- **CSS组织**：使用BEM命名方法论
- **响应式设计**：移动优先的响应式设计
- **CSS变量**：使用变量定义颜色和主题
- **性能优化**：最小化DOM操作，优化选择器

### JavaScript规范

- **ES6+特性**：使用现代JavaScript特性
- **模块化**：使用模块化开发
- **异步处理**：使用Promise和async/await
- **错误处理**：捕获并报告所有错误
- **事件处理**：使用事件委托和防抖/节流优化

详见 [code_standards.json](rules/code_standards.json)

## 可访问性规范

项目严格遵循可访问性标准，确保所有用户都能无障碍使用。

### 视觉可访问性

- **颜色对比度**：符合WCAG 2.1 AA标准
- **文本大小**：支持动态类型，最小字体14px
- **暗黑模式**：支持系统深色模式
- **图像替代文本**：所有图像提供替代文本

### 交互可访问性

- **触控目标**：最小尺寸44×44pt
- **手势替代**：复杂手势提供替代方式
- **键盘导航**：支持完整的键盘操作
- **交互反馈**：明确的操作反馈

### 听觉可访问性

- **字幕**：视频内容提供字幕
- **声音替代**：声音反馈提供视觉替代

### 认知可访问性

- **简洁语言**：使用简单明了的语言
- **清晰导航**：导航结构简单明确
- **错误处理**：友好的错误提示和恢复机制
- **时间限制**：避免或可延长时间限制

### 儿童内容特定标准

- **多种阅读级别**：根据年龄提供不同难度
- **朗读功能**：提供故事朗读
- **清晰指示**：交互元素有明确指示

详见 [accessibility_guidelines.json](rules/accessibility_guidelines.json)

## 版本控制规范

- **分支策略**：采用GitFlow工作流
- **提交信息**：使用约定式提交格式
- **版本号**：采用语义化版本控制
- **变更日志**：维护详细的变更记录

## 代码审查流程

- **审查重点**：功能完整性、代码质量、性能、安全、测试覆盖
- **自动化检查**：使用SwiftLint等工具
- **持续集成**：确保代码可以构建和通过测试

## 模块化开发规则

宝宝故事应用采用严格的模块化开发架构，确保代码组织清晰、组件复用率高、扩展性强。

### 前端模块化规则

#### 目录结构规范
```
BaoBao/
├── App/                   // 应用入口
├── Modules/               // 功能模块
├── Common/                // 通用组件
├── Services/              // 服务层
├── Models/                // 数据模型
├── Resources/             // 资源文件
└── Config/                // 配置文件
```

#### 模块划分原则
- **独立性原则**：每个模块独立负责一个功能领域
- **内聚性原则**：相关功能集中在同一模块
- **松耦合原则**：模块间保持低耦合
- **职责单一原则**：每个组件只负责单一功能

#### 视图组件化规则
- **原子组件**：最基本UI元素（按钮、输入框）
- **分子组件**：功能单元（故事卡片、表单行）
- **有机体组件**：完整功能视图（故事详情页）

#### MVVM实现规范
- ViewModel定义清晰的发布属性
- 使用依赖注入获取服务
- 区分生命周期、公开方法和私有方法
- 错误处理统一且明确

#### 导航规则
- 使用协调器模式(Coordinator)管理导航
- 每个主要模块拥有独立导航协调器
- 使用类型安全路由枚举定义导航路径

#### 状态管理
- 使用`@Published`和`ObservableObject`管理状态
- 全局状态使用环境对象(EnvironmentObject)
- 复杂状态变化使用状态机实现

### 后端模块化规则

#### API服务架构
- 基础请求层负责网络通信
- 服务层封装业务逻辑
- 使用协议定义服务接口，实现松耦合

#### 服务层职责划分
- **APIService**: 网络请求和基础错误处理
- **StoryService**: 故事生成相关逻辑
- **VoiceService**: 语音合成和播放
- **AuthService**: 认证和用户管理
- **AnalyticsService**: 数据分析和行为追踪

#### 错误处理规范
- 定义明确的错误类型和错误码
- 提供用户友好的错误消息
- 实现全局错误处理机制
- 关键错误必须记录日志

#### 重试机制规范
- 实现指数退避重试策略
- API限流时自动重试
- 重试次数和间隔可配置
- 临时错误与永久错误区分处理

#### 后端安全规则
- 所有API请求通过HTTPS
- 实现请求签名机制
- 敏感数据加密存储
- 实现内容过滤机制
- API密钥安全管理

### 数据库模块化规则

#### 数据模型设计规范
- 实体名称使用单数形式，首字母大写
- 关系命名反映业务含义
- 明确定义删除规则
- 大文本内容使用外部存储

#### 本地存储访问层规范
- 使用仓储模式(Repository Pattern)封装数据访问
- 定义清晰的CRUD操作接口
- 使用泛型简化通用操作

#### 数据查询优化规则
- 为频繁查询的属性建立索引
- 使用预取技术减少数据库访问
- 实现分页加载机制
- 避免循环中执行查询
- 优先使用复合谓词
- 对于频繁查询路径，考虑反规范化设计

#### 数据持久化策略
- 使用多上下文架构
  - `viewContext`: UI操作的主上下文
  - `backgroundContext`: 后台任务上下文
  - `childContext`: 临时操作的子上下文
- 大量数据操作使用批量操作API
- 批量操作后合并变更到视图上下文

#### 数据安全与完整性
- 敏感数据加密存储
- 实现实体验证规则
- 提供数据验证和清理机制

#### 数据迁移与备份
- 实现版本化的模型迁移
- 定期自动备份机制
- 提供数据恢复功能

#### 多设备同步与冲突解决
- 使用CloudKit实现iCloud同步
- 实现增量同步机制
- 定义明确的冲突解决规则
- 提供用户选择界面解决复杂冲突

#### 性能监控与优化
- 监控关键操作执行时间
- 定期分析存储大小和增长趋势
- 跟踪查询频率和复杂度
- 定期执行数据库维护任务

#### 审计与合规
- 实现变更跟踪机制
- 限制收集的儿童个人信息
- 实现数据老化机制
- 提供数据导出和删除功能

### 跨层通信规则

#### 依赖注入原则
- 使用协议定义服务接口
- 使用依赖注入容器管理服务实例
- 避免使用单例模式，除非必要

#### 事件传递机制
- 使用Combine框架实现响应式编程
- 定义明确的事件发布者和订阅者
- 系统级事件使用NotificationCenter

#### WebView与原生代码通信
- 定义清晰的JavaScript接口
- 实现类型安全的消息传递
- 验证所有从WebView接收的数据

#### 数据流向规范
- 清晰数据流向：视图层⟷视图模型层⟷服务层⟷数据层
- 使用单向数据流模式简化状态管理
- 避免跨层引用，遵守分层架构

---

本规则文档最后更新于：2023-05-12 
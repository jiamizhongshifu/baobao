<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>服务测试 - 宝宝故事</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        .container {
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .test-section {
            background-color: #fff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 10px;
        }
        
        textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .test-button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .primary-button {
            background-color: #4CAF50;
            color: white;
        }
        
        .primary-button:hover {
            background-color: #3e8e41;
        }
        
        .secondary-button {
            background-color: #2196F3;
            color: white;
        }
        
        .secondary-button:hover {
            background-color: #1976D2;
        }
        
        .result-container {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        
        .result-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }
        
        .result-content {
            white-space: pre-wrap;
            font-size: 0.9rem;
            color: #555;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .spinner {
            width: 30px;
            height: 30px;
            margin-right: 10px;
        }
        
        .audio-controls {
            margin-top: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .audio-button {
            padding: 8px 15px;
            border: none;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .play-button {
            background-color: #4CAF50;
            color: white;
        }
        
        .play-button:hover {
            background-color: #3e8e41;
        }
        
        .stop-button {
            background-color: #f44336;
            color: white;
        }
        
        .stop-button:hover {
            background-color: #d32f2f;
        }
        
        .audio-status {
            font-size: 0.9rem;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="back-nav">
                <button onclick="history.back()" class="back-nav-button">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h1>服务测试</h1>
            </div>
        </header>
        
        <main>
            <!-- 故事生成服务测试 -->
            <section class="test-section">
                <h2 class="section-title">
                    <i class="fas fa-book"></i>
                    故事生成服务测试
                </h2>
                
                <div class="form-group">
                    <label for="theme">故事主题</label>
                    <select id="theme">
                        <option value="魔法世界">魔法世界</option>
                        <option value="动物朋友">动物朋友</option>
                        <option value="太空冒险">太空冒险</option>
                        <option value="公主王子">公主王子</option>
                        <option value="海底世界">海底世界</option>
                        <option value="恐龙时代">恐龙时代</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="childName">宝宝名称</label>
                    <input type="text" id="childName" value="小明" placeholder="请输入宝宝名称">
                </div>
                
                <div class="form-group">
                    <label for="childAge">宝宝年龄</label>
                    <input type="number" id="childAge" value="5" min="1" max="12" placeholder="请输入宝宝年龄">
                </div>
                
                <div class="form-group">
                    <label for="childInterests">宝宝兴趣爱好（用逗号分隔）</label>
                    <input type="text" id="childInterests" value="恐龙,汽车,画画" placeholder="例如：恐龙,汽车,画画">
                </div>
                
                <div class="form-group">
                    <label for="storyLength">故事长度</label>
                    <select id="storyLength">
                        <option value="短篇">短篇（约3分钟）</option>
                        <option value="中篇" selected>中篇（约5分钟）</option>
                        <option value="长篇">长篇（约8分钟）</option>
                    </select>
                </div>
                
                <div class="button-group">
                    <button id="generateStoryButton" class="test-button primary-button">
                        <i class="fas fa-magic"></i> 生成故事
                    </button>
                </div>
                
                <div id="storyResult" class="result-container" style="display: none;">
                    <div class="result-title">生成结果：</div>
                    <div id="storyTitle" class="result-title"></div>
                    <div id="storyContent" class="result-content"></div>
                </div>
                
                <div id="storyLoading" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <div>正在生成故事，请稍候...</div>
                </div>
            </section>
            
            <!-- 语音合成服务测试 -->
            <section class="test-section">
                <h2 class="section-title">
                    <i class="fas fa-microphone"></i>
                    语音合成服务测试
                </h2>
                
                <div class="form-group">
                    <label for="voiceType">语音类型</label>
                    <select id="voiceType">
                        <option value="萍萍阿姨" selected>萍萍阿姨（女声）</option>
                        <option value="大树叔叔">大树叔叔（男声）</option>
                        <option value="豆豆">豆豆（儿童声）</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="speechText">文本内容</label>
                    <textarea id="speechText" placeholder="请输入要合成语音的文本内容">从前有一个小朋友叫小明，他非常喜欢探险。有一天，他在家门口发现了一个神秘的盒子。</textarea>
                </div>
                
                <div class="button-group">
                    <button id="synthesizeSpeechButton" class="test-button primary-button">
                        <i class="fas fa-volume-up"></i> 合成语音
                    </button>
                    <button id="useStoryButton" class="test-button secondary-button" disabled>
                        <i class="fas fa-file-import"></i> 使用故事内容
                    </button>
                </div>
                
                <div id="speechResult" class="result-container" style="display: none;">
                    <div class="result-title">合成结果：</div>
                    <div id="audioURL" class="result-content"></div>
                    
                    <div class="audio-controls">
                        <button id="playAudioButton" class="audio-button play-button">
                            <i class="fas fa-play"></i> 播放
                        </button>
                        <button id="stopAudioButton" class="audio-button stop-button">
                            <i class="fas fa-stop"></i> 停止
                        </button>
                        <div id="audioStatus" class="audio-status">准备就绪</div>
                    </div>
                </div>
                
                <div id="speechLoading" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <div>正在合成语音，请稍候...</div>
                </div>
            </section>
        </main>
    </div>
    
    <script src="../js/common.js"></script>
    <script src="../js/api.js"></script>
    <script>
        // 全局变量
        let generatedStory = null;
        let synthesizedAudioURL = null;
        let isPlaying = false;
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 初始化故事生成按钮
            document.getElementById('generateStoryButton').addEventListener('click', generateStory);
            
            // 初始化语音合成按钮
            document.getElementById('synthesizeSpeechButton').addEventListener('click', synthesizeSpeech);
            
            // 初始化使用故事内容按钮
            document.getElementById('useStoryButton').addEventListener('click', useStoryContent);
            
            // 初始化播放音频按钮
            document.getElementById('playAudioButton').addEventListener('click', playAudio);
            
            // 初始化停止音频按钮
            document.getElementById('stopAudioButton').addEventListener('click', stopAudio);
        });
        
        // 生成故事
        async function generateStory() {
            try {
                // 获取表单数据
                const theme = document.getElementById('theme').value;
                const childName = document.getElementById('childName').value;
                const childAge = parseInt(document.getElementById('childAge').value);
                const childInterests = document.getElementById('childInterests').value.split(',').map(item => item.trim());
                const storyLength = document.getElementById('storyLength').value;
                
                // 验证表单数据
                if (!childName) {
                    showToast('请输入宝宝名称');
                    return;
                }
                
                if (isNaN(childAge) || childAge < 1 || childAge > 12) {
                    showToast('请输入有效的宝宝年龄（1-12岁）');
                    return;
                }
                
                // 显示加载中
                document.getElementById('storyLoading').style.display = 'flex';
                document.getElementById('storyResult').style.display = 'none';
                
                // 调用API生成故事
                generatedStory = await api.generateStory(theme, childName, childAge, childInterests, storyLength);
                
                // 显示生成结果
                document.getElementById('storyTitle').textContent = generatedStory.title;
                document.getElementById('storyContent').textContent = generatedStory.content;
                document.getElementById('storyResult').style.display = 'block';
                
                // 启用使用故事内容按钮
                document.getElementById('useStoryButton').disabled = false;
                
                // 隐藏加载中
                document.getElementById('storyLoading').style.display = 'none';
                
                showToast('故事生成成功');
            } catch (error) {
                console.error('生成故事失败:', error);
                
                // 隐藏加载中
                document.getElementById('storyLoading').style.display = 'none';
                
                showToast(`生成故事失败: ${error.message}`);
            }
        }
        
        // 合成语音
        async function synthesizeSpeech() {
            try {
                // 获取表单数据
                const voiceType = document.getElementById('voiceType').value;
                const text = document.getElementById('speechText').value;
                
                // 验证表单数据
                if (!text) {
                    showToast('请输入要合成语音的文本内容');
                    return;
                }
                
                // 显示加载中
                document.getElementById('speechLoading').style.display = 'flex';
                document.getElementById('speechResult').style.display = 'none';
                
                // 调用API合成语音
                const result = await api.synthesizeSpeech(text, voiceType);
                synthesizedAudioURL = result.audioURL;
                
                // 显示合成结果
                document.getElementById('audioURL').textContent = synthesizedAudioURL;
                document.getElementById('speechResult').style.display = 'block';
                document.getElementById('audioStatus').textContent = '准备就绪';
                
                // 隐藏加载中
                document.getElementById('speechLoading').style.display = 'none';
                
                showToast('语音合成成功');
            } catch (error) {
                console.error('合成语音失败:', error);
                
                // 隐藏加载中
                document.getElementById('speechLoading').style.display = 'none';
                
                showToast(`合成语音失败: ${error.message}`);
            }
        }
        
        // 使用故事内容
        function useStoryContent() {
            if (generatedStory) {
                document.getElementById('speechText').value = generatedStory.content;
                showToast('已使用故事内容');
            } else {
                showToast('请先生成故事');
            }
        }
        
        // 播放音频
        async function playAudio() {
            if (!synthesizedAudioURL) {
                showToast('请先合成语音');
                return;
            }
            
            try {
                if (!isPlaying) {
                    await api.playAudio(synthesizedAudioURL);
                    isPlaying = true;
                    document.getElementById('audioStatus').textContent = '正在播放...';
                    showToast('开始播放');
                    
                    // 模拟播放完成
                    setTimeout(() => {
                        if (isPlaying) {
                            isPlaying = false;
                            document.getElementById('audioStatus').textContent = '播放完成';
                        }
                    }, 10000); // 假设音频长度为10秒
                }
            } catch (error) {
                console.error('播放音频失败:', error);
                showToast(`播放失败: ${error.message}`);
            }
        }
        
        // 停止音频
        async function stopAudio() {
            if (isPlaying) {
                try {
                    await api.stopAudio();
                    isPlaying = false;
                    document.getElementById('audioStatus').textContent = '已停止';
                    showToast('已停止播放');
                } catch (error) {
                    console.error('停止音频失败:', error);
                    showToast(`停止失败: ${error.message}`);
                }
            }
        }
    </script>
</body>
</html> 
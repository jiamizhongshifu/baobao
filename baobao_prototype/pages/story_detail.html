<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ•…äº‹è¯¦æƒ… - å®å®æ•…äº‹</title>
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/story_detail.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* åŸºç¡€æ ·å¼ */
        body {
            background-color: #F2E9DE;
            color: #333;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 100%;
            overflow-x: hidden;
        }
        
        /* é¡¶éƒ¨å¯¼èˆªæ ·å¼ - ä¸profile.htmlä¿æŒä¸€è‡´ */
        .header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .back-button {
            width: 40px;
            height: 40px;
            border-radius: 20px;
            background-color: #FFF;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            color: #333;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border: none;
            font-size: 18px;
            cursor: pointer;
        }
        
        .page-title {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }
        
        /* æ•…äº‹è¯¦æƒ…æ ·å¼ */
        .story-detail-container {
            padding: 0;
            max-width: 800px;
            margin: 0 auto;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .story-card {
            background-color: #FFF;
            border-radius: 25px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.5s;
            margin-bottom: 20px;
        }
        
        .story-header {
            margin-bottom: 25px;
            text-align: center;
        }
        
        .story-title {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 15px;
            color: #333;
            line-height: 1.3;
        }
        
        .story-meta {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            color: #666;
            font-size: 0.95rem;
        }
        
        .story-meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
            transition: transform 0.2s ease;
            padding: 6px 12px;
            background-color: #F2E9DE;
            border-radius: 15px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .story-meta-item:hover {
            transform: translateY(-2px);
        }
        
        .story-meta-item i {
            color: #666;
        }
        
        .story-meta-item span {
            color: #333;
            font-weight: 600;
        }
        
        .story-voice-tag {
            background-color: #E3F2FD;
            color: #1976D2;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
            font-weight: 600;
        }
        
        .story-voice-tag:hover {
            transform: scale(1.05);
        }
        
        .story-cover {
            height: 200px;
            background-size: cover;
            background-position: center;
            border-radius: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .story-cover:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.4) 100%);
            z-index: 1;
        }
        
        .story-cover:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        
        .story-content {
            background-color: #ffffff;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            line-height: 1.8;
            white-space: pre-wrap;
            color: #333;
            font-size: 1.05rem;
            transition: transform 0.3s ease;
        }
        
        .story-content:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        
        .audio-controls {
            background-color: #ffffff;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .audio-progress {
            width: 100%;
            height: 6px;
            background-color: #e5e5ea;
            border-radius: 3px;
            margin-bottom: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: height 0.2s ease;
        }
        
        .audio-progress:hover {
            height: 8px;
        }
        
        .progress-bar {
            height: 100%;
            background-color: #1976D2;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .audio-time {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #666;
        }
        
        .story-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
            padding-bottom: 20px;
        }
        
        .action-button {
            padding: 12px 24px;
            border-radius: 20px;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
            min-width: 120px;
        }
        
        .action-button:active {
            transform: scale(0.98);
        }
        
        .play-button {
            background-color: #000;
            color: white;
        }
        
        .play-button:hover {
            background-color: #333;
            transform: scale(1.05);
        }
        
        .pause-button {
            background-color: #FFD966;
            color: #333;
        }
        
        .pause-button:hover {
            background-color: #F1C232;
            transform: scale(1.05);
        }
        
        .back-action-button {
            background-color: #FFF;
            color: #333;
            border: 2px dashed #FFD966;
        }
        
        .back-action-button:hover {
            background-color: #F2E9DE;
            transform: scale(1.05);
        }
        
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 70vh;
            gap: 20px;
            animation: pulse 2s infinite ease-in-out;
        }
        
        @keyframes pulse {
            0% { opacity: 0.8; }
            50% { opacity: 1; }
            100% { opacity: 0.8; }
        }
        
        .loading-container p {
            color: #666;
            font-size: 1.1rem;
            text-align: center;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #F2E9DE;
            border-top: 4px solid #FFD966;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .retry-button {
            margin-top: 15px;
            padding: 8px 20px;
            border: none;
            border-radius: 15px;
            background-color: #FFD966;
            color: #333;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .retry-button:hover {
            background-color: #F1C232;
            transform: scale(1.05);
        }
        
        /* ç§»åŠ¨è®¾å¤‡é€‚é… */
        @media (max-width: 767px) {
            .story-title {
                font-size: 24px;
            }
            
            .story-meta {
                gap: 8px;
            }
            
            .story-content {
                padding: 20px;
                font-size: 1rem;
            }
            
            .story-detail-container {
                padding: 0;
            }
            
            .story-cover {
                height: 150px;
            }
            
            .action-button {
                padding: 10px 20px;
                min-width: 100px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="back-button" onclick="history.back()">
                    <i class="fas fa-arrow-left"></i>
                </button>
            <h1 class="page-title">æ•…äº‹è¯¦æƒ…</h1>
            </div>
        
        <main>
            <div class="story-detail-container" id="storyDetailContainer">
                <!-- åŠ è½½çŠ¶æ€ -->
                <div class="loading-container" id="loadingContainer">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨åŠ è½½æ•…äº‹...</p>
                </div>
                
                <!-- é”™è¯¯çŠ¶æ€ -->
                <div class="error-container" id="errorContainer" style="display: none;">
                    <div class="error-icon">
                        <i class="fas fa-exclamation-circle"></i>
                    </div>
                    <div class="error-message" id="errorMessage">
                        åŠ è½½æ•…äº‹æ—¶å‡ºé”™
                    </div>
                    <button class="retry-button" id="retryButton">
                        <i class="fas fa-redo"></i> é‡è¯•
                    </button>
                </div>
                
                <!-- æ•…äº‹è¯¦æƒ… -->
                <div class="story-detail" id="storyDetail" style="display: none;">
                    <div class="story-card">
                    <!-- æ•…äº‹å°é¢ -->
                    <div class="story-cover" id="storyCover">
                        <!-- å°é¢èƒŒæ™¯å›¾ä¼šé€šè¿‡JavaScriptè®¾ç½® -->
                    </div>
                    
                    <!-- æ•…äº‹æ ‡é¢˜å’Œå…ƒæ•°æ® -->
                    <div class="story-header">
                        <h2 class="story-title" id="storyTitle">æ•…äº‹æ ‡é¢˜</h2>
                        <div class="story-meta">
                            <div class="story-meta-item">
                                <i class="fas fa-child"></i>
                                <span id="storyChild">å°æ˜</span>
                            </div>
                            <div class="story-meta-item">
                                <i class="fas fa-tag"></i>
                                <span id="storyTheme">é­”æ³•ä¸–ç•Œ</span>
                            </div>
                            <div class="story-meta-item">
                                <i class="fas fa-calendar-alt"></i>
                                <span id="storyDate">2023-05-20</span>
                                </div>
                                <span id="storyVoice" class="story-voice-tag">
                                    <i class="fas fa-microphone-alt"></i>
                                    é»˜è®¤éŸ³è‰²
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- éŸ³é¢‘æ§åˆ¶å™¨ -->
                    <div class="audio-controls" id="audioControls">
                        <div class="audio-progress">
                            <div class="progress-bar" id="progressBar"></div>
                        </div>
                        <div class="audio-time">
                            <span id="currentTime">00:00</span>
                            <span id="totalTime">00:00</span>
                        </div>
                    </div>
                    
                    <!-- æ•…äº‹å†…å®¹ -->
                    <div class="story-content" id="storyContent">
                        æ•…äº‹å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º...
                    </div>
                    
                    <!-- æ•…äº‹æ“ä½œæŒ‰é’® -->
                    <div class="story-actions">
                        <button class="action-button back-action-button" onclick="history.back()">
                            <i class="fas fa-arrow-left"></i> è¿”å›
                        </button>
                        <button class="action-button play-button" id="playButton">
                            <i class="fas fa-play"></i> æ’­æ”¾
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <script src="../js/common.js"></script>
    <script src="../js/api.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let storyData = null;
        let isPlaying = false;
        let audioInterval = null;
        let audioStartTime = 0;
        let audioDuration = 0;
        
        // è°ƒè¯•å·¥å…·å‡½æ•°
        function debug(message, data) {
            const now = new Date();
            const timestamp = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}.${now.getMilliseconds().toString().padStart(3, '0')}`;
            
            if (data) {
                console.log(`[${timestamp}] ğŸ“ ${message}`, data);
            } else {
                console.log(`[${timestamp}] ğŸ“ ${message}`);
            }
        }
        
        function debugError(message, error) {
            const now = new Date();
            const timestamp = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}.${now.getMilliseconds().toString().padStart(3, '0')}`;
            
            if (error) {
                console.error(`[${timestamp}] âŒ ${message}`, error);
            } else {
                console.error(`[${timestamp}] âŒ ${message}`);
            }
        }
        
        // æš´éœ²ç»™çˆ¶é¡µé¢(é¦–é¡µ)è°ƒç”¨çš„æ›´æ–°æ’­æ”¾çŠ¶æ€çš„å‡½æ•°
        window.updatePlayStateFromParent = function(playingState, playingStory) {
            debug(`æ”¶åˆ°çˆ¶é¡µé¢æ’­æ”¾çŠ¶æ€æ›´æ–°: playing=${playingState}`, playingStory);
            
            if (playingStory && storyData && playingStory.id === storyData.id) {
                isPlaying = playingState;
                if (isPlaying) {
                    // æ›´æ–°UIä¸ºæ’­æ”¾çŠ¶æ€
                    const playButton = document.getElementById('playButton');
                    playButton.className = 'action-button pause-button';
                    playButton.innerHTML = '<i class="fas fa-pause"></i> æš‚åœ';
                    
                    // å¼€å§‹æ›´æ–°è¿›åº¦æ¡
                    if (!audioInterval) {
                        audioStartTime = Date.now() - (parseFloat(document.getElementById('progressBar').style.width || '0') / 100 * audioDuration * 1000);
                        updateProgress();
                        audioInterval = setInterval(updateProgress, 100);
                    }
                } else {
                    // æ›´æ–°UIä¸ºæš‚åœçŠ¶æ€
                    const playButton = document.getElementById('playButton');
                    playButton.className = 'action-button play-button';
                    playButton.innerHTML = '<i class="fas fa-play"></i> æ’­æ”¾';
                    
                    // åœæ­¢è¿›åº¦æ¡æ›´æ–°
                    clearInterval(audioInterval);
                    audioInterval = null;
                }
            }
        };
        
        // é¡µé¢åŠ è½½å®Œæˆåè·å–æ•…äº‹æ•°æ®
        document.addEventListener('DOMContentLoaded', () => {
            debug('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹è·å–æ•…äº‹æ•°æ®');
            
            // æ·»åŠ è°ƒè¯•æŒ‰é’®
            addDebugTools();
            
            // è·å–æ•…äº‹æ•°æ®
            fetchStoryData();
        });
        
        // æ·»åŠ è°ƒè¯•å·¥å…·
        function addDebugTools() {
            // ä»…åœ¨å¼€å‘ç¯å¢ƒä¸‹æ·»åŠ è°ƒè¯•å·¥å…·
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                const debugPanel = document.createElement('div');
                debugPanel.style.position = 'fixed';
                debugPanel.style.bottom = '10px';
                debugPanel.style.right = '10px';
                debugPanel.style.zIndex = '9999';
                debugPanel.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
                debugPanel.style.color = 'white';
                debugPanel.style.padding = '10px';
                debugPanel.style.borderRadius = '5px';
                debugPanel.style.fontSize = '12px';
                debugPanel.innerHTML = `
                    <div>è°ƒè¯•é¢æ¿</div>
                    <button id="mockDataBtn" style="margin: 5px; padding: 5px 10px;">å¼ºåˆ¶ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®</button>
                    <button id="reloadBtn" style="margin: 5px; padding: 5px 10px;">é‡æ–°åŠ è½½</button>
                    <div id="debugInfo" style="margin-top: 10px; font-size: 11px;"></div>
                `;
                document.body.appendChild(debugPanel);
                
                document.getElementById('mockDataBtn').addEventListener('click', () => {
                    localStorage.setItem('useMockData', 'true');
                    debug('å·²è®¾ç½®å¼ºåˆ¶ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®');
                    location.reload();
                });
                
                document.getElementById('reloadBtn').addEventListener('click', () => {
                    debug('æ‰‹åŠ¨é‡æ–°åŠ è½½é¡µé¢');
                    location.reload();
                });
                
                // æ˜¾ç¤ºå½“å‰URLå‚æ•°
                const urlParams = new URLSearchParams(window.location.search);
                const debugInfo = document.getElementById('debugInfo');
                debugInfo.innerHTML = `å½“å‰æ•…äº‹ID: ${urlParams.get('id')}<br>`;
                debugInfo.innerHTML += `å¼ºåˆ¶æ¨¡æ‹Ÿ: ${localStorage.getItem('useMockData') === 'true' ? 'æ˜¯' : 'å¦'}<br>`;
            }
        }
        
        // è·å–æ•…äº‹æ•°æ®
        async function fetchStoryData() {
            debug('å¼€å§‹è·å–æ•…äº‹æ•°æ®');
            const urlParams = new URLSearchParams(window.location.search);
            let storyId = urlParams.get('id');
            const useMock = urlParams.get('mock') === 'true' || localStorage.getItem('useMockData') === 'true';
            
            // å¤„ç†IDæ ¼å¼ï¼Œå°† story-1 è½¬æ¢ä¸º story_1 ä»¥åŒ¹é…æ¨¡æ‹Ÿæ•°æ®
            if (storyId && storyId.includes('-')) {
                storyId = storyId.replace(/-/g, '_');
                debug('è½¬æ¢åçš„æ•…äº‹ID:', storyId);
            }
                
                if (!storyId) {
                debugError('æœªæ‰¾åˆ°æ•…äº‹ID');
                showError('æ— æ³•åŠ è½½æ•…äº‹ï¼Œç¼ºå°‘æ•…äº‹ID');
                return;
            }
            
            // ä¸ºæ–¹ä¾¿æµ‹è¯•ï¼Œå¼ºåˆ¶ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
            localStorage.setItem('useMockData', 'true');
            
            // å°è¯•ä»æœ¬åœ°å­˜å‚¨ä¸­è·å–æ•°æ®
            try {
                const cachedStory = localStorage.getItem(`story_${storyId}`);
                if (cachedStory) {
                    const parsedStory = JSON.parse(cachedStory);
                    debug('ä»æœ¬åœ°å­˜å‚¨è·å–æ•…äº‹æ•°æ®:', parsedStory);
                    
                    // è®¾ç½®å…¨å±€æ•…äº‹æ•°æ®
                    storyData = parsedStory;
                    
                    // æ˜¾ç¤ºæ•…äº‹è¯¦æƒ…
                    displayStoryDetail(parsedStory);
                    
                    // æ£€æŸ¥æ’­æ”¾çŠ¶æ€
                    checkGlobalPlayingState();
                    
                    // åœ¨åå°ç»§ç»­è·å–æœ€æ–°æ•°æ®ï¼ˆæ— éœ€ç­‰å¾…ï¼‰
                    setTimeout(() => refreshStoryData(storyId, true), 100);
                    return;
                }
            } catch (cacheError) {
                debugError('è¯»å–æœ¬åœ°ç¼“å­˜å¤±è´¥:', cacheError);
            }
            
            // å¦‚æœæ²¡æœ‰ç¼“å­˜ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
            try {
                debug('ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®æ¨¡å¼');
                const mockData = getMockStoryData(storyId);
                
                // è®¾ç½®å…¨å±€æ•…äº‹æ•°æ®
                storyData = mockData;
                debug('ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®:', mockData);
                
                // æ˜¾ç¤ºæ•…äº‹è¯¦æƒ…
                displayStoryDetail(mockData);
                
                // æ£€æŸ¥æ’­æ”¾çŠ¶æ€
                checkGlobalPlayingState();
            } catch (error) {
                debugError('è·å–æ¨¡æ‹Ÿæ•°æ®å¤±è´¥:', error);
                showError('åŠ è½½æ•…äº‹æ•°æ®å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // åˆ·æ–°æ•…äº‹æ•°æ®ï¼ˆä»APIè·å–æœ€æ–°æ•°æ®ï¼‰
        async function refreshStoryData(storyId, useMock) {
            try {
                // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»ï¼ˆå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡åŠ è½½ï¼‰
                if (!storyData) {
                    const loadingContainer = document.getElementById('loadingContainer');
                    loadingContainer.style.display = 'flex';
                }
                
                // å¦‚æœå¼ºåˆ¶ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸
                if (useMock) {
                    console.log('å¼ºåˆ¶ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®æ¨¡å¼');
                    throw new Error('å¼ºåˆ¶ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®');
                }
                
                // åˆ›å»ºAPIå®ä¾‹
                console.log('å¼€å§‹ä»APIè·å–æ•…äº‹:', storyId);
                let result = null;
                
                try {
                    // å°è¯•ä»APIè·å–æ•°æ®
                    if (typeof BaoBaoAPI === 'function') {
                        const api = new BaoBaoAPI();
                        result = await api.getStoryDetail(storyId);
                        console.log('APIè¿”å›ç»“æœ:', result);
                    } else {
                        throw new Error('BaoBaoAPIæœªå®šä¹‰');
                    }
                } catch (apiError) {
                    console.warn('APIè°ƒç”¨å¤±è´¥:', apiError);
                    throw apiError; // ä¼ é€’é”™è¯¯ä»¥ä¾¿ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                }
                
                // æ£€æŸ¥å¹¶å¤„ç†APIç»“æœ
                if (result && (result.story || result.data)) {
                    // è®¾ç½®å…¨å±€æ•…äº‹æ•°æ®
                    storyData = result.story || result.data;
                    console.log('æˆåŠŸè·å–æ•…äº‹æ•°æ®:', storyData);
                    
                    // æ˜¾ç¤ºæ•…äº‹è¯¦æƒ…ï¼ˆå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡åŠ è½½ï¼‰
                    if (!document.getElementById('storyDetail').style.display || document.getElementById('storyDetail').style.display === 'none') {
                displayStoryDetail(storyData);
                        
                        // æ£€æŸ¥æ’­æ”¾çŠ¶æ€
                        checkGlobalPlayingState();
                    }
                } else {
                    throw new Error('APIè¿”å›æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                }
                
            } catch (error) {
                console.error('è·å–æ•…äº‹æ•°æ®å‡ºé”™ï¼Œå°†ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®:', error);
                
                // å¦‚æœå°šæœªæ˜¾ç¤ºå†…å®¹ï¼Œåˆ™ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                if (!storyData || !document.getElementById('storyDetail').style.display || document.getElementById('storyDetail').style.display === 'none') {
                    // ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®
                    const mockData = getMockStoryData(storyId);
                    
                    // è®¾ç½®å…¨å±€æ•…äº‹æ•°æ®
                    storyData = mockData;
                    console.log('ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®:', mockData);
                    
                    // æ˜¾ç¤ºæ•…äº‹è¯¦æƒ…
                    displayStoryDetail(mockData);
                    
                    // æ£€æŸ¥æ’­æ”¾çŠ¶æ€
                    checkGlobalPlayingState();
                }
            }
        }
        
        // è·å–æ¨¡æ‹Ÿæ•…äº‹æ•°æ®
        function getMockStoryData(storyId) {
            debug('å°è¯•è·å–æ¨¡æ‹Ÿæ•…äº‹:', storyId);
            
            const mockStories = {
                'story_1': {
                    id: 'story_1',
                    title: 'å°æ˜çš„é­”æ³•å†’é™©',
                    content: 'ä»å‰æœ‰ä¸€ä¸ªå°æœ‹å‹å«å°æ˜ï¼Œä»–ä½åœ¨ä¸€ä¸ªç¾ä¸½çš„å°é•‡ä¸Šã€‚æœ‰ä¸€å¤©ï¼Œä»–åœ¨åé™¢é‡Œå‘ç°äº†ä¸€æœ¬ç¥å¥‡çš„ä¹¦ã€‚å½“ä»–æ‰“å¼€è¿™æœ¬ä¹¦æ—¶ï¼Œä¸€é“äº®å…‰é—ªè¿‡ï¼Œä»–è¢«å¸¦åˆ°äº†ä¸€ä¸ªç¥å¥‡çš„ä¸–ç•Œã€‚\n\nåœ¨è¿™ä¸ªä¸–ç•Œé‡Œï¼Œæ ‘æœ¨ä¼šè¯´è¯ï¼ŒèŠ±æœµä¼šå”±æ­Œï¼Œå°åŠ¨ç‰©ä»¬ç©¿ç€æ¼‚äº®çš„è¡£æœèµ°è·¯ã€‚å°æ˜å¾ˆæƒŠè®¶ï¼Œä»–é‡åˆ°äº†ä¸€åªæˆ´ç€çœ¼é•œçš„å…”å­ã€‚\n\n"ä½ å¥½ï¼Œå°æ˜ï¼"å…”å­è¯´é“ï¼Œ"æˆ‘æ˜¯è¿™ä¸ªé­”æ³•æ£®æ—çš„å‘å¯¼ï¼Œæˆ‘å«èƒ¡èåœã€‚æˆ‘çŸ¥é“ä½ æ˜¯æ€ä¹ˆæ¥åˆ°è¿™é‡Œçš„ã€‚"\n\nå°æ˜é—®ï¼š"æˆ‘æ€ä¹ˆæ‰èƒ½å›å®¶å‘¢ï¼Ÿ"\n\nèƒ¡èåœè¯´ï¼š"ä½ éœ€è¦æ‰¾åˆ°æ£®æ—æ·±å¤„çš„é­”æ³•æ°´æ™¶ï¼Œå®ƒèƒ½å®ç°ä½ çš„æ„¿æœ›ã€‚ä½†æ˜¯è·¯ä¸Šæœ‰å¾ˆå¤šæŒ‘æˆ˜ï¼Œä½ å¿…é¡»å‹‡æ•¢é¢å¯¹ã€‚"\n\näºæ˜¯å°æ˜å’Œèƒ¡èåœå¼€å§‹äº†å†’é™©ä¹‹æ—…ã€‚ä»–ä»¬ç©¿è¿‡ä¼šå”±æ­Œçš„èŠ±æµ·ï¼Œè¶Šè¿‡ä¼šè·³èˆçš„å°æºªï¼Œæœ€åæ¥åˆ°äº†ä¸€åº§é«˜å±±å‰ã€‚\n\nå±±æ´é‡Œä½ç€ä¸€æ¡å‹å¥½çš„é¾™ï¼Œå®ƒå®ˆæŠ¤ç€é­”æ³•æ°´æ™¶ã€‚é¾™è¯´ï¼š"åªæœ‰å›ç­”å‡ºæˆ‘çš„è°œè¯­ï¼Œæ‰èƒ½å¾—åˆ°æ°´æ™¶ã€‚"\n\nè°œè¯­æ˜¯ï¼š"ä»€ä¹ˆä¸œè¥¿è¶Šåˆ†äº«è¶Šå¤šï¼Ÿ"\n\nå°æ˜æƒ³äº†æƒ³ï¼Œå›ç­”ï¼š"æ˜¯çŸ¥è¯†å’Œçˆ±ï¼"\n\né¾™ç¬‘äº†ï¼š"ç­”å¯¹äº†ï¼ä½ æ˜¯ä¸ªèªæ˜çš„å­©å­ã€‚"\n\né¾™ç»™äº†å°æ˜é­”æ³•æ°´æ™¶ï¼Œå°æ˜è®¸æ„¿å›å®¶ã€‚ä¸€é“å…‰èŠ’é—ªè¿‡ï¼Œä»–å›åˆ°äº†è‡ªå·±çš„åé™¢ã€‚\n\nä»é‚£ä»¥åï¼Œå°æ˜å¸¸å¸¸æ‰“å¼€é‚£æœ¬ç¥å¥‡çš„ä¹¦ï¼Œå»é­”æ³•ä¸–ç•Œå’Œä»–çš„æœ‹å‹ä»¬ç©è€ã€‚ä½†ä»–ä»ä¸å¿˜è®°é¾™çš„è°œè¯­â€”â€”çŸ¥è¯†å’Œçˆ±ï¼Œè¶Šåˆ†äº«è¶Šå¤šã€‚',
                    childName: 'å°æ˜',
                    theme: 'é­”æ³•ä¸–ç•Œ',
                    createdAt: new Date().toISOString(),
                    voiceType: 'æ¸©æŸ”ç«¥å£°',
                    audioDuration: 120
                },
                'story_2': {
                    id: 'story_2',
                    title: 'æµ·åº•æ¢é™©è®°',
                    content: 'å°çº¢å¾ˆå–œæ¬¢æµ·æ´‹ï¼Œå¥¹çš„æˆ¿é—´é‡Œåˆ°å¤„éƒ½æ˜¯æµ·æ´‹ç”Ÿç‰©çš„å›¾ç‰‡å’Œæ¨¡å‹ã€‚æœ‰ä¸€å¤©æ™šä¸Šï¼Œå¥¹åšäº†ä¸€ä¸ªå¥‡å¦™çš„æ¢¦ã€‚\n\nåœ¨æ¢¦é‡Œï¼Œå¥¹å˜æˆäº†ä¸€æ¡ç¾ä¸½çš„å°é±¼ï¼Œå¯ä»¥åœ¨æµ·åº•è‡ªç”±åœ°æ¸¸åŠ¨ã€‚æµ·æ°´æ¸…æ¾ˆé€æ˜ï¼Œé˜³å…‰é€è¿‡æµ·é¢ç…§è¿›æ¥ï¼Œå½¢æˆäº†ç¾ä¸½çš„å…‰æŸ±ã€‚\n\nå°çº¢æ¸¸å•Šæ¸¸ï¼Œé‡åˆ°äº†ä¸€åªå‹å¥½çš„æµ·é¾Ÿçˆ·çˆ·ã€‚æµ·é¾Ÿçˆ·çˆ·è¯´ï¼š"å°æœ‹å‹ï¼Œæ¬¢è¿æ¥åˆ°æµ·åº•ä¸–ç•Œï¼æˆ‘å·²ç»æ´»äº†ä¸€ç™¾å¤šå²äº†ï¼Œè®©æˆ‘å¸¦ä½ å‚è§‚å§ã€‚"\n\næµ·é¾Ÿçˆ·çˆ·å¸¦ç€å°çº¢æ¸¸è§ˆäº†è‰²å½©æ–‘æ–“çš„çŠç‘šç¤ï¼Œé‚£é‡Œä½ç€å„ç§å„æ ·çš„å°é±¼ï¼›å‚è§‚äº†æµ·è‰æ£®æ—ï¼Œé‡Œé¢è—ç€èªæ˜çš„ç« é±¼å…ˆç”Ÿï¼›è¿˜å»äº†æ·±æµ·åŒºï¼Œè§åˆ°äº†ä¼šå‘å…‰çš„ç¥å¥‡ç”Ÿç‰©ã€‚\n\né€”ä¸­ï¼Œä»–ä»¬çœ‹åˆ°ä¸€äº›å¡‘æ–™è¢‹å’Œåƒåœ¾æ¼‚åœ¨æ°´ä¸­ã€‚ä¸€æ¡å°é±¼ä¸å°å¿ƒè¢«å¡‘æ–™è¢‹ç¼ ä½äº†ï¼Œæµ·é¾Ÿçˆ·çˆ·èµ¶ç´§å»æ•‘å®ƒã€‚\n\næµ·é¾Ÿçˆ·çˆ·å¯¹å°çº¢è¯´ï¼š"çœ‹åˆ°äº†å—ï¼Ÿè¿™äº›åƒåœ¾å¯¹æˆ‘ä»¬æµ·æ´‹ç”Ÿç‰©é€ æˆäº†å¾ˆå¤§ä¼¤å®³ã€‚è®¸å¤šæµ·é¾Ÿè¯¯æŠŠå¡‘æ–™è¢‹å½“æˆæ°´æ¯åƒä¸‹å»ï¼Œä¼šç”Ÿç—…ç”šè‡³æ­»äº¡ã€‚"\n\nå°çº¢å¾ˆéš¾è¿‡ï¼Œå¥¹å†³å®šè¦ä¿æŠ¤æµ·æ´‹ç¯å¢ƒã€‚\n\nå¿½ç„¶ï¼Œå¥¹å¬åˆ°å¦ˆå¦ˆçš„å£°éŸ³ï¼š"å°çº¢ï¼Œèµ·åºŠäº†ï¼"\n\nå°çº¢é†’æ¥äº†ï¼Œå‘ç°è‡ªå·±èººåœ¨åºŠä¸Šã€‚è™½ç„¶åªæ˜¯ä¸€ä¸ªæ¢¦ï¼Œä½†å¥¹è®°ä½äº†æµ·é¾Ÿçˆ·çˆ·çš„è¯ã€‚\n\nä»é‚£å¤©èµ·ï¼Œå°çº¢æ›´åŠ çƒ­çˆ±æµ·æ´‹ï¼Œå¥¹å’Œå®¶äººä¸€èµ·å‚åŠ äº†æµ·æ»©æ¸…æ´æ´»åŠ¨ï¼Œè¿˜åœ¨å­¦æ ¡ä¸¾åŠäº†ä¿æŠ¤æµ·æ´‹çš„å®£ä¼ æ´»åŠ¨ï¼Œå‘Šè¯‰å¤§å®¶å‡å°‘ä½¿ç”¨å¡‘æ–™åˆ¶å“çš„é‡è¦æ€§ã€‚\n\nå°çº¢çŸ¥é“ï¼Œä¿æŠ¤åœ°çƒä¸Šçš„æ¯ä¸€æ»´æ°´ï¼Œå°±æ˜¯ä¿æŠ¤æˆ‘ä»¬å…±åŒçš„å®¶å›­ã€‚',
                    childName: 'å°çº¢',
                    theme: 'æµ·åº•ä¸–ç•Œ',
                    createdAt: new Date().toISOString(),
                    voiceType: 'æ´»æ³¼å¥³å£°',
                    audioDuration: 150
                }
            };
            
            // æ‰©å±•æ¨¡æ‹Ÿæ•°æ®ï¼Œç¡®ä¿æ›´å¤šIDéƒ½èƒ½åŒ¹é…
            if (storyId.startsWith('story')) {
                const num = storyId.replace(/[^0-9]/g, '');
                if (num && !mockStories[storyId]) {
                    debug(`ä¸ºID ${storyId} åˆ›å»ºåŠ¨æ€æ¨¡æ‹Ÿæ•…äº‹`);
                    mockStories[storyId] = {
                        id: storyId,
                        title: `åˆ›æ„æ•…äº‹ #${num}`,
                        content: 'è¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨ç”Ÿæˆçš„æ•…äº‹å†…å®¹ï¼Œç”¨äºæµ‹è¯•å’Œå¼€å‘ã€‚\n\nä»å‰æœ‰ä¸€ä¸ªå‹‡æ•¢çš„å­©å­ï¼Œä»–å–œæ¬¢æ¢ç´¢å‘¨å›´çš„ä¸–ç•Œã€‚æ¯å¤©æ”¾å­¦åï¼Œä»–éƒ½ä¼šå»å°åŒºé™„è¿‘çš„æ ‘æ—æ¢é™©ï¼Œå¯»æ‰¾å¥‡å¦™çš„å‘ç°ã€‚\n\næœ‰ä¸€å¤©ï¼Œä»–åœ¨ä¸€æ£µå¤§æ ‘ä¸‹å‘ç°äº†ä¸€ä¸ªå¥‡æ€ªçš„ç›’å­ï¼Œç›’å­ä¸Šåˆ»ç€ç¥ç§˜çš„ç¬¦å·ã€‚ä»–å°å¿ƒç¿¼ç¿¼åœ°æ‰“å¼€ç›’å­ï¼Œå‘ç°é‡Œé¢æœ‰ä¸€å¼ åœ°å›¾ã€‚\n\nåœ°å›¾ä¸Šæ ‡ç€"å®è—"çš„ä½ç½®ï¼Œå°±åœ¨ä»–ä»¬å°åŒºä¸è¿œçš„åœ°æ–¹ã€‚ä»–å†³å®šç¬¬äºŒå¤©å’Œå¥½æœ‹å‹ä¸€èµ·å»å¯»å®ã€‚\n\nç¬¬äºŒå¤©ï¼Œä»–ä»¬æŒ‰ç…§åœ°å›¾æŒ‡å¼•ï¼Œæ‰¾åˆ°äº†"å®è—"çš„ä½ç½®ã€‚ä»¤ä»–ä»¬æƒŠè®¶çš„æ˜¯ï¼Œé‚£é‡Œæ˜¯ä¸€ç‰‡è¢«é—å¿˜çš„èŠ±å›­ï¼Œå¼€æ»¡äº†ç¾ä¸½çš„èŠ±æœµï¼Œè¿˜æœ‰è®¸å¤šè´è¶åœ¨é£èˆã€‚\n\nä»–ä»¬å†³å®šä¿æŠ¤è¿™ä¸ªç§˜å¯†èŠ±å›­ï¼Œæ¯å‘¨æ¥æµ‡æ°´ã€é™¤è‰ï¼Œè®©è¿™ç‰‡ç¾ä¸½çš„åœ°æ–¹ç»§ç»­èŒå£®æˆé•¿ã€‚è¿™æ˜¯ä»–ä»¬å‘ç°çš„æœ€çè´µçš„å®è—â€”â€”å¤§è‡ªç„¶çš„ç¾ä¸½ç¤¼ç‰©ã€‚',
                        childName: 'æ¢é™©å®¶',
                        theme: 'å¥‡é‡å†’é™©',
                        createdAt: new Date().toISOString(),
                        voiceType: 'æ ‡å‡†ç«¥å£°',
                        audioDuration: 110
                    };
                }
            }
            
            // å¦‚æœæ‰¾ä¸åˆ°æŒ‡å®šidçš„æ•…äº‹ï¼Œè¿”å›é»˜è®¤æ•…äº‹
            if (!mockStories[storyId]) {
                debugError(`æœªæ‰¾åˆ°IDä¸º ${storyId} çš„æ¨¡æ‹Ÿæ•…äº‹ï¼Œä½¿ç”¨é»˜è®¤æ•…äº‹`);
                return {
                    id: storyId || 'default_story',
                    title: 'æ¨¡æ‹Ÿæ•…äº‹ - ' + (storyId || 'æœªçŸ¥ID'),
                    content: 'è¿™æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿçš„æ•…äº‹å†…å®¹ï¼Œç”¨äºåœ¨æ— æ³•è¿æ¥æœåŠ¡å™¨æ—¶å±•ç¤ºã€‚\n\nä»å‰æœ‰ä¸€ä¸ªå°æœ‹å‹ï¼Œä»–éå¸¸å–œæ¬¢å¬æ•…äº‹ã€‚æ¯å¤©æ™šä¸Šï¼Œä»–éƒ½ä¼šç¼ ç€å¦ˆå¦ˆç»™ä»–è®²ä¸€ä¸ªæ–°æ•…äº‹ã€‚\n\næœ‰ä¸€å¤©ï¼Œä»–å†³å®šè‡ªå·±åˆ›ä½œæ•…äº‹ã€‚ä»–æ‹¿å‡ºç¬”å’Œæœ¬å­ï¼Œå¼€å§‹å†™ä¸‹è‡ªå·±æƒ³è±¡ä¸­çš„å¥‡å¦™ä¸–ç•Œã€‚åœ¨ä»–çš„æ•…äº‹é‡Œï¼Œæœ‰ä¼šé£çš„æ±½è½¦ï¼Œä¼šè¯´è¯çš„åŠ¨ç‰©ï¼Œè¿˜æœ‰ç¥å¥‡çš„é­”æ³•ã€‚\n\nä»–çš„æ•…äº‹è¶Šå†™è¶Šé•¿ï¼Œè¶Šå†™è¶Šç²¾å½©ã€‚å¾ˆå¿«ï¼Œä»–çš„åŒå­¦ä»¬éƒ½å–œæ¬¢ä¸Šäº†ä»–çš„æ•…äº‹ï¼Œå¸¸å¸¸å›´åœ¨ä»–èº«è¾¹å¬ä»–è®²è¿°ã€‚\n\nåæ¥ï¼Œä»–é•¿å¤§äº†ï¼Œæˆä¸ºäº†ä¸€åè‘—åçš„å„¿ç«¥æ•…äº‹ä½œå®¶ï¼Œä»–çš„æ•…äº‹è¢«ç¿»è¯‘æˆå¤šç§è¯­è¨€ï¼Œè®©ä¸–ç•Œå„åœ°çš„å­©å­éƒ½èƒ½äº«å—åˆ°æƒ³è±¡çš„ä¹è¶£ã€‚',
                    childName: 'å®å®',
                    theme: 'æˆé•¿æ•…äº‹',
                    createdAt: new Date().toISOString(),
                    voiceType: 'æ¸©æŸ”ç”·å£°',
                    audioDuration: 100
                };
            }
            
            debug(`æˆåŠŸè·å–IDä¸º ${storyId} çš„æ¨¡æ‹Ÿæ•…äº‹`);
            return mockStories[storyId];
        }
        
        // æ£€æŸ¥å…¨å±€æ’­æ”¾çŠ¶æ€
        function checkGlobalPlayingState() {
            try {
                // å°è¯•ä¸çˆ¶é¡µé¢é€šä¿¡ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨æ’­æ”¾çš„æ•…äº‹
                if (window.opener && window.opener.getCurrentPlayingStory) {
                    const playingStory = window.opener.getCurrentPlayingStory();
                    if (playingStory && playingStory.id === storyData.id) {
                        // å¦‚æœå½“å‰æ•…äº‹æ­£åœ¨é¦–é¡µæ’­æ”¾ï¼ŒåŒæ­¥æ’­æ”¾çŠ¶æ€
                        isPlaying = true;
                        updateUIForPlayingState();
                    }
                }
            } catch (e) {
                console.warn('æ— æ³•æ£€æŸ¥å…¨å±€æ’­æ”¾çŠ¶æ€', e);
            }
        }
        
        // æ›´æ–°UIæ˜¾ç¤ºæ’­æ”¾çŠ¶æ€
        function updateUIForPlayingState() {
            const playButton = document.getElementById('playButton');
            if (isPlaying) {
                playButton.className = 'action-button pause-button';
                playButton.innerHTML = '<i class="fas fa-pause"></i> æš‚åœ';
            } else {
                playButton.className = 'action-button play-button';
                playButton.innerHTML = '<i class="fas fa-play"></i> æ’­æ”¾';
            }
        }
        
        // æ˜¾ç¤ºæ•…äº‹è¯¦æƒ…
        function displayStoryDetail(story) {
            debug('å¼€å§‹æ˜¾ç¤ºæ•…äº‹è¯¦æƒ…:', story);
            
            // ç¡®ä¿storyå¯¹è±¡å­˜åœ¨ä¸”åŒ…å«å¿…è¦å±æ€§
            if (!story || !story.title || !story.content) {
                debugError('æ•…äº‹æ•°æ®ä¸å®Œæ•´:', story);
                showError('æ•…äº‹æ•°æ®ä¸å®Œæ•´ï¼Œè¯·é‡è¯•');
                return;
            }
            
            try {
                // å°†æ•…äº‹æ•°æ®ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼Œä»¥ä¾¿åœ¨é¡µé¢åˆ·æ–°åä»èƒ½æ˜¾ç¤º
                try {
                    localStorage.setItem(`story_${story.id}`, JSON.stringify(story));
                    debug('å·²å°†æ•…äº‹æ•°æ®ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
                } catch (storageError) {
                    debugError('æ— æ³•ä¿å­˜æ•…äº‹æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨:', storageError);
                }
                
            // éšè—åŠ è½½ä¸­
            document.getElementById('loadingContainer').style.display = 'none';
            
            // æ˜¾ç¤ºæ•…äº‹è¯¦æƒ…
                const storyDetail = document.getElementById('storyDetail');
                storyDetail.style.opacity = '0';
                storyDetail.style.display = 'block';
            
            // éšæœºé€‰æ‹©ä¸€ä¸ªèƒŒæ™¯å›¾
            const backgroundIndex = Math.floor(Math.random() * 5) + 1;
            const backgroundImage = `../images/story_covers/cover_${backgroundIndex}.jpg`;
            
                // è®¾ç½®æ•…äº‹å°é¢èƒŒæ™¯
            const storyCover = document.getElementById('storyCover');
                if (storyCover) {
            storyCover.style.backgroundImage = `url('${backgroundImage}')`;
                    debug('è®¾ç½®å°é¢èƒŒæ™¯å›¾ç‰‡:', backgroundImage);
                }
            
                // è®¾ç½®æ•…äº‹æ ‡é¢˜å’Œå…ƒæ•°æ®
            document.getElementById('storyTitle').textContent = story.title;
                document.getElementById('storyChild').textContent = story.childName || 'æœªçŸ¥';
                document.getElementById('storyTheme').textContent = story.theme || 'æœªçŸ¥ä¸»é¢˜';
            document.getElementById('storyDate').textContent = formatDate(new Date(story.createdAt));
                document.getElementById('storyVoice').textContent = story.voiceType || 'é»˜è®¤éŸ³è‰²';
            document.getElementById('storyContent').textContent = story.content;
            
            // è®¾ç½®éŸ³é¢‘æ—¶é•¿
                audioDuration = story.audioDuration || (story.content.length * 0.3);
                document.getElementById('totalTime').textContent = formatTime(audioDuration);
                
                // æ·»åŠ æ·¡å…¥åŠ¨ç”»
                setTimeout(() => {
                    storyDetail.style.transition = 'opacity 0.5s ease';
                    storyDetail.style.opacity = '1';
                }, 50);
            
            // è®¾ç½®æ’­æ”¾æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                const playButton = document.getElementById('playButton');
                playButton.removeEventListener('click', togglePlayPause);
                playButton.addEventListener('click', togglePlayPause);
                
                debug('æ•…äº‹è¯¦æƒ…æ˜¾ç¤ºå®Œæˆ');
            } catch (error) {
                debugError('æ˜¾ç¤ºæ•…äº‹è¯¦æƒ…æ—¶å‡ºé”™:', error);
                showError('æ˜¾ç¤ºæ•…äº‹è¯¦æƒ…æ—¶å‡ºé”™ï¼Œè¯·é‡è¯•');
            }
        }
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const loadingContainer = document.getElementById('loadingContainer');
            const loadingText = loadingContainer.querySelector('p');
            const spinner = loadingContainer.querySelector('.spinner');
            
            if (spinner) {
                spinner.style.display = 'none';
            }
            
            loadingText.style.color = '#ff3b30';
            loadingText.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}<br><button onclick="location.reload()" class="retry-button">é‡è¯•</button>`;
        }
        
        // åˆ‡æ¢æ’­æ”¾/æš‚åœçŠ¶æ€
        function togglePlayPause() {
            const playButton = document.getElementById('playButton');
            
            if (isPlaying) {
                // æš‚åœæ’­æ”¾
                isPlaying = false;
                clearInterval(audioInterval);
                audioInterval = null;
                
                // æ›´æ–°æŒ‰é’®æ ·å¼
                playButton.className = 'action-button play-button';
                playButton.innerHTML = '<i class="fas fa-play"></i> æ’­æ”¾';
                
                // é€šçŸ¥é¦–é¡µæ›´æ–°çŠ¶æ€ï¼ˆå¦‚æœæ˜¯ä»é¦–é¡µæ‰“å¼€çš„ï¼‰
                notifyParentPage(false);
            } else {
                // å¼€å§‹æ’­æ”¾
                isPlaying = true;
                audioStartTime = Date.now() - (parseFloat(document.getElementById('progressBar').style.width || '0') / 100 * audioDuration * 1000);
                
                // æ›´æ–°è¿›åº¦æ¡
                updateProgress();
                audioInterval = setInterval(updateProgress, 100);
                
                // æ›´æ–°æŒ‰é’®æ ·å¼
                playButton.className = 'action-button pause-button';
                playButton.innerHTML = '<i class="fas fa-pause"></i> æš‚åœ';
                
                // é€šçŸ¥é¦–é¡µæ›´æ–°çŠ¶æ€ï¼ˆå¦‚æœæ˜¯ä»é¦–é¡µæ‰“å¼€çš„ï¼‰
                notifyParentPage(true);
            }
        }
        
        // é€šçŸ¥çˆ¶é¡µé¢ï¼ˆé¦–é¡µï¼‰æ›´æ–°æ’­æ”¾çŠ¶æ€
        function notifyParentPage(playingState) {
            try {
                if (window.opener && window.opener.updatePlayStateFromDetailPage) {
                    window.opener.updatePlayStateFromDetailPage(playingState, storyData);
                }
            } catch (e) {
                console.warn('æ— æ³•é€šçŸ¥çˆ¶é¡µé¢æ›´æ–°æ’­æ”¾çŠ¶æ€', e);
            }
        }
        
        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress() {
            const elapsedTime = (Date.now() - audioStartTime) / 1000;
            const progressPercent = Math.min(100, (elapsedTime / audioDuration) * 100);
            
            // æ›´æ–°è¿›åº¦æ¡
            document.getElementById('progressBar').style.width = `${progressPercent}%`;
            
            // æ›´æ–°å½“å‰æ—¶é—´
            document.getElementById('currentTime').textContent = formatTime(elapsedTime);
            
            // å¦‚æœæ’­æ”¾å®Œæ¯•ï¼Œé‡ç½®çŠ¶æ€
            if (progressPercent >= 100) {
                isPlaying = false;
                clearInterval(audioInterval);
                audioInterval = null;
                
                // æ›´æ–°æŒ‰é’®æ ·å¼
                const playButton = document.getElementById('playButton');
                playButton.className = 'action-button play-button';
                playButton.innerHTML = '<i class="fas fa-play"></i> æ’­æ”¾';
            }
        }
        
        // æ ¼å¼åŒ–æ—¶é—´ï¼ˆç§’ -> MM:SSï¼‰
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
    </script>
</body>
</html> 